<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gang Intel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: Arial, sans-serif; background:#f9fafb; margin:0; padding:20px; text-align:center; }
  h1 { margin-bottom:20px; }
  button { padding:10px 20px; margin-bottom:20px; cursor:pointer; border:none; border-radius:6px; font-size:16px; color:white; }
  .gang-card { background:white; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); margin:20px auto; width:80%; max-width:800px; overflow:hidden; text-align:left; position:relative; }
  .gang-header { background:#222; color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; font-size:1.2rem; cursor:pointer; }
  .gang-content { display:none; padding:16px; }
  .gang-card.active .gang-content { display:block; }
  .gang-card img { width:100%; max-height:200px; object-fit:cover; border-radius:8px; margin-top:10px; cursor:pointer; transition:transform 0.2s; }
  .gang-card img:hover { transform:scale(1.05); }
  .gang-card iframe { width:100%; height:200px; border:1px solid #ccc; border-radius:8px; margin-top:10px; }
  .edit-btn { background-color:#2563eb; }
  .delete-btn { background-color:#dc2626; }
  .expand-btn { background-color:#f59e0b; }
  .edit-icon { cursor:pointer; margin-left:5px; color:#2563eb; }
  .edit-icon:hover { color:#1d4ed8; }

  /* Modal */
  .modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background-color:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; }
  .modal-content { width:90vw; height:90vh; max-width:1200px; max-height:90vh; }
  .modal-content iframe, .modal-content img { width:100%; height:100%; border:none; }
  .close-btn { position:absolute; top:20px; right:30px; color:white; font-size:30px; font-weight:bold; cursor:pointer; }

  /* Hide Supabase UI banner/toast */
  div#__supabase_ui_container__ {
    display: none !important;
  }
</style>
</head>
<body>

<h1>Gang Intel</h1>
<button id="addGangBtn" style="background:#4caf50;">➕ Add Gang</button>
<div id="gangContainer"></div>

<!-- Modal -->
<div id="modal" class="modal">
  <span class="close-btn">&times;</span>
  <div class="modal-content" id="modalContent"></div>
</div>

<script>
const SUPABASE_URL = "https://esdqtnqozcfmcpjsskku.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzZHF0bnFvemNmbWNwanNza2t1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3Mjk3NzYsImV4cCI6MjA3MjMwNTc3Nn0.7wWpR-DD3LcU_iZe2UHQ926r_UF0WHQs2lHM5SQ4vKk";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const gangContainer = document.getElementById("gangContainer");
const addGangBtn = document.getElementById("addGangBtn");
const modal = document.getElementById("modal");
const modalContent = document.getElementById("modalContent");
const closeBtn = document.querySelector(".close-btn");

closeBtn.onclick = () => { modal.style.display="none"; modalContent.innerHTML=""; }
window.onclick = e => { if(e.target===modal){ modal.style.display="none"; modalContent.innerHTML=""; } }

// Make any field editable
function makeEditable(label, value, column, gangId){
  const p = document.createElement("p");
  const textSpan = document.createElement("span");
  textSpan.textContent = value || "";
  textSpan.style.marginLeft="5px";

  const editIcon = document.createElement("span");
  editIcon.textContent="✏️";
  editIcon.className="edit-icon";

  editIcon.onclick = async e => {
    e.stopPropagation();
    const input = column==="notes"?document.createElement("textarea"):document.createElement("input");
    input.value = textSpan.textContent;
    input.style.width="70%";
    input.style.marginLeft="5px";
    textSpan.replaceWith(input);
    input.focus();

    input.onblur = async () => {
      const newValue = input.value.trim();
      const { error } = await supabase.from("gang_intel").update({[column]: newValue}).eq("id", gangId);
      if(error){ alert("Error updating "+column+": "+error.message); input.replaceWith(textSpan); }
      else { textSpan.textContent = newValue; input.replaceWith(textSpan); }
    };
    if(column!=="notes") input.onkeydown = e => { if(e.key==="Enter") input.blur(); }
  };

  p.innerHTML = `<strong>${label}:</strong>`;
  p.appendChild(textSpan);
  p.appendChild(editIcon);
  return p;
}

// Editable gang name
function makeNameEditable(name, gangId){
  const container = document.createElement("div");
  const nameSpan = document.createElement("span");
  nameSpan.textContent = name;
  nameSpan.style.fontWeight="bold";
  nameSpan.style.fontSize="1.2rem";

  const editIcon = document.createElement("span");
  editIcon.textContent="✏️";
  editIcon.className="edit-icon";

  editIcon.onclick = async e => {
    e.stopPropagation();
    const input = document.createElement("input");
    input.value = nameSpan.textContent;
    input.style.fontSize="1.2rem";
    input.style.fontWeight="bold";
    nameSpan.replaceWith(input);
    input.focus();

    input.onblur = async () => {
      const newName = input.value.trim();
      const { error } = await supabase.from("gang_intel").update({name:newName}).eq("id", gangId);
      if(error){ alert("Error updating name:"+error.message); input.replaceWith(nameSpan); }
      else { nameSpan.textContent = newName; input.replaceWith(nameSpan); }
    };
    input.onkeydown = e => { if(e.key==="Enter") input.blur(); }
  };

  container.appendChild(nameSpan);
  container.appendChild(editIcon);
  return container;
}

// Load all gangs
async function loadGangs(){
  const {data,error} = await supabase.from("gang_intel").select("*").order('id',{ascending:true});
  if(error){ console.error(error); return; }
  gangContainer.innerHTML="";

  data.forEach(gang => {
    const card = document.createElement("div");
    card.className="gang-card";
    card.dataset.id = gang.id;

    const header = document.createElement("div");
    header.className="gang-header";
    header.appendChild(makeNameEditable(gang.name || "", gang.id));

    const content = document.createElement("div");
    content.className="gang-content";

    // Editable fields with correct column names
    content.appendChild(makeEditable("Case File By", gang.casefileby || "", "casefileby", gang.id));
    content.appendChild(makeEditable("Members", gang.members || "", "members", gang.id));
    content.appendChild(makeEditable("Notes", gang.notes || "", "notes", gang.id));
    content.appendChild(makeEditable("Google Doc URL", gang.googledocurl || "", "googledocurl", gang.id));

    const lastUpdated = document.createElement("p");
    lastUpdated.innerHTML=`<em>Last Updated: ${gang.updated_at ? new Date(gang.updated_at).toLocaleString() : ""}</em>`;
    content.appendChild(lastUpdated);

    // Images container
    const imagesContainer = document.createElement("div");
    imagesContainer.style.display="flex";
    imagesContainer.style.flexWrap="wrap";
    imagesContainer.style.gap="10px";
    content.appendChild(imagesContainer);

    const renderImages = () => {
      imagesContainer.innerHTML="";
      if(gang.images){
        gang.images.split(",").forEach((url,index) => {
          if(url.trim()){
            const imgWrapper = document.createElement("div");
            imgWrapper.style.position="relative";

            const img = document.createElement("img");
            img.src = url.trim();
            img.style.width="120px";
            img.style.height="80px";
            img.style.objectFit="cover";
            img.style.borderRadius="6px";
            img.style.cursor="pointer";
            img.onclick = () => { modal.style.display="flex"; modalContent.innerHTML=`<img src="${img.src}">`; };

            const editIcon = document.createElement("span");
            editIcon.textContent="✏️";
            editIcon.style.position="absolute";
            editIcon.style.top="2px";
            editIcon.style.right="2px";
            editIcon.style.cursor="pointer";
            editIcon.onclick = async e => {
              e.stopPropagation();
              const newUrl = prompt("Edit image URL:", url.trim());
              if(newUrl){
                const imgsArr = gang.images.split(",");
                imgsArr[index] = newUrl.trim();
                const { error } = await supabase.from("gang_intel").update({images: imgsArr.join(",")}).eq("id", gang.id);
                if(error) alert("Error updating image: "+error.message);
                else { gang.images = imgsArr.join(","); renderImages(); }
              }
            };

            const delIcon = document.createElement("span");
            delIcon.textContent="🗑️";
            delIcon.style.position="absolute";
            delIcon.style.bottom="2px";
            delIcon.style.right="2px";
            delIcon.style.cursor="pointer";
            delIcon.onclick = async e => {
              e.stopPropagation();
              if(confirm("Delete this image?")){
                const imgsArr = gang.images.split(",");
                imgsArr.splice(index,1);
                const { error } = await supabase.from("gang_intel").update({images: imgsArr.join(",")}).eq("id", gang.id);
                if(error) alert("Error deleting image: "+error.message);
                else { gang.images = imgsArr.join(","); renderImages(); }
              }
            };

            imgWrapper.appendChild(img);
            imgWrapper.appendChild(editIcon);
            imgWrapper.appendChild(delIcon);
            imagesContainer.appendChild(imgWrapper);
          }
        });
      }
    };
    renderImages();

    const addImageBtn = document.createElement("button");
    addImageBtn.textContent="➕ Add Image";
    addImageBtn.style.backgroundColor="#10b981";
    addImageBtn.onclick = async () => {
      const url = prompt("Enter image URL:");
      if(url){
        const newImages = gang.images ? gang.images + "," + url.trim() : url.trim();
        const { error } = await supabase.from("gang_intel").update({images: newImages}).eq("id", gang.id);
        if(error) alert("Error adding image: "+error.message);
        else { gang.images = newImages; renderImages(); }
      }
    };
    content.appendChild(addImageBtn);

    if(gang.googledocurl){
      const iframe = document.createElement("iframe");
      iframe.src = gang.googledocurl.includes("/edit")?gang.googledocurl:`${gang.googledocurl}/edit?usp=sharing`;
      content.appendChild(iframe);

      const expandBtn = document.createElement("button");
      expandBtn.textContent="🔍 Expand Doc";
      expandBtn.className="expand-btn";
      expandBtn.onclick = () => { modal.style.display="flex"; modalContent.innerHTML=`<iframe src="${iframe.src}"></iframe>`; };
      content.appendChild(expandBtn);
    }

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent="🗑️ Delete Gang";
    deleteBtn.className="delete-btn";
    deleteBtn.onclick = async () => {
      if(confirm(`Delete ${gang.name}?`)){
        const {error} = await supabase.from("gang_intel").delete().eq("id", gang.id);
        if(error) alert("Error:"+error.message);
        else loadGangs();
      }
    };
    content.appendChild(deleteBtn);

    card.appendChild(header);
    card.appendChild(content);
    gangContainer.appendChild(card);

    header.onclick = () => card.classList.toggle("active");
  });
}

// Add new gang
addGangBtn.onclick = async () => {
  const name = prompt("Enter gang name:");
  if(name){
    const { error } = await supabase.from("gang_intel").insert([{
      name: name,
      members: "",
      images: "",
      casefileby: "",
      notes: "",
      googledocurl: ""
    }]);
    if(error) alert("Error adding gang:"+error.message);
    else loadGangs();
  }
};

// Real-time updates
supabase.channel('realtime-gangs')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'gang_intel' }, payload => {
    loadGangs();
  }).subscribe();

loadGangs();
</script>
</body>
</html>

